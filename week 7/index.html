<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Week 7. Transform log file data to json and visualize</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>
    <h1>Performance statistics</h1>
    <div id="container"></div>


    <script>
        const url = "https://iv4r6d3mrg.execute-api.us-east-2.amazonaws.com/dev"
        d3.json(url).then(response => {

            console.log("response = ", response)

            Object.keys(response).forEach((tag, index) => {

                const tagDiv = d3.select("#container")
                    .append("div")
                    .attr("id", tag)
                    .style("margin", "30px")

                tagDiv.append("div")
                    .text((index + 1) + ". " + tag)



                const data = response[tag]

                // https://observablehq.com/@d3/line-chart

                margin = ({ top: 20, right: 30, bottom: 30, left: 40 })

                height = 500
                width = 500


                const svg = tagDiv.append("div")
                    .style("width", "500px")
                    .style("height", "500px")
                    .append("svg")
                    .attr("viewBox", [0, 0, width, height]);

                const x = d3.scaleBand()
                    .domain(d3.range(data.length))
                    .range([margin.left, width - margin.right])
                    .padding(0.1)

                const y = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.max)]).nice()
                    .range([height - margin.bottom, margin.top])


                const xAxis = g => g
                    .attr("transform", `translate(0,${height - margin.bottom})`)
                    .call(d3.axisBottom(x).tickFormat(i => data[i].period).tickSizeOuter(0))

                const yAxis = g => g
                    .attr("transform", `translate(${margin.left},0)`)
                    .call(d3.axisLeft(y))
                    .call(g => g.select(".domain").remove())
                    .call(g => g.select(".tick:last-of-type text").clone()
                        .attr("x", 3)
                        .attr("text-anchor", "start")
                        .attr("font-weight", "bold")
                        .text(data.y))


                svg.append("g")
                    .call(xAxis);

                svg.append("g")
                    .call(yAxis);

                    addLine("avg", "red", svg)
                    addLine("min", "green", svg)
                    addLine("max", "blue", svg)
                    addLine("stdDev", "orange", svg)

                function addLine(key, color, svg) {
                   
                   const line = d3.line()
                    .defined(d => !isNaN(d[key]))
                    .x((d, i) => x(i))
                    .y(d => y(d[key]))

                    svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", color)
                    .attr("stroke-width", 1.5)
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("d", line);

                 }

            })
        })
    </script>
</body>

</html>
